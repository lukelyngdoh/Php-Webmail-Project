<?php
    function getBody($uid, $imap){
    $body = get_part($imap, $uid, "TEXT/HTML");
        if ($body == "") {
        $body = get_part($imap, $uid, "TEXT/PLAIN");
    }
        return $body;
    }

    function get_part($imap, $uid, $mimetype='', $structure = false, $partNumber = false){
        if (!$structure){
               $structure = imap_fetchstructure($imap, $uid, FT_UID);
        }
        if ($structure){
            if ($mimetype == get_mime_type($structure)) {
                if (!$partNumber) {
                    $partNumber = 1;
                }
                $text = imap_fetchbody($imap, $uid, $partNumber, FT_UID);
            
            }
            if ($structure->type == 1) {
                foreach ($structure->parts as $index => $subStruct) {
                    $prefix = "";
                    if ($partNumber) {
                        $prefix = $partNumber . ".";
                    }
                    $data = get_part($imap, $uid, $mimetype, $subStruct, $prefix . ($index + 1));
                    if ($data) {
                        return $data;
                    }
                }
            }
        }
        return false;
    }

    function get_mime_type($structure){
        $primaryMimetype = array("TEXT", "MULTIPART", "MESSAGE", "APPLICATION", "AUDIO", "IMAGE", "VIDEO", "OTHER");
        if ($structure->subtype) {
           return $primaryMimetype[(int)$structure->type] . "/" . $structure->subtype;
        }
        return "TEXT/PLAIN";
    }

?>